/*
 * Copyright (c) 2013-2022 Snowplow Analytics Ltd. All rights reserved.
 *
 * This program is licensed to you under the Apache License Version 2.0, and
 * you may not use this file except in compliance with the Apache License
 * Version 2.0.  You may obtain a copy of the Apache License Version 2.0 at
 * http://www.apache.org/licenses/LICENSE-2.0.
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the Apache License Version 2.0 is distributed on an "AS
 * IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 * implied.  See the Apache License Version 2.0 for the specific language
 * governing permissions and limitations there under.
 */
package com.snowplowanalytics.snowplow.collectors.scalastream

import com.snowplowanalytics.iglu.core.{SchemaKey, SchemaVer, SelfDescribingData}
import com.snowplowanalytics.snowplow.collectors.scalastream.model.TelemetryConfig
import com.snowplowanalytics.snowplow.collectors.scalastream.telemetry.CloudVendor._
import io.circe.Json
import io.circe.generic.auto._
import io.circe.syntax._

package object telemetry {
  private val teleUuid: String = java.util.UUID.randomUUID.toString

  private val telemetrySchema: SchemaKey =
    SchemaKey("com.snowplowanalytics.oss", "oss_context", "jsonschema", SchemaVer.Full(1, 0, 1))

  /** Makes SelfDescribingData to be used for telemetry heartbeats.
    * Don't forget to cache this event after the creation.
    *
    * @param teleCfg - telemetry configuration
    * @param cloud - cloud vendor
    * @param region - deployment region
    * @param appName - application name as defined during build (take it from BuildInfo)
    * @param appVersion - application name as defined during build (take it from BuildInfo)
    * @return heartbeat event. Same event should be used for all heartbeats.
    */
  def makeHeartbeatEvent(
    teleCfg: TelemetryConfig,
    cloud: Option[CloudVendor],
    region: Option[String],
    appName: String,
    appVersion: String
  ): SelfDescribingData[Json] = SelfDescribingData(
    telemetrySchema,
    TelemetryPayload(
      userProvidedId     = teleCfg.userProvidedId,
      moduleName         = teleCfg.moduleName,
      moduleVersion      = teleCfg.moduleVersion,
      instanceId         = teleCfg.instanceId,
      autoGeneratedId    = teleCfg.autoGeneratedId,
      region             = region,
      cloud              = cloud,
      applicationName    = appName,
      applicationVersion = appVersion,
      appGeneratedId     = teleUuid
    ).asJson
  )

}
